{% extends "base.html" %}

{% block title %}Управление ремонтами{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0"><i class="fas fa-wrench"></i> Управление ремонтами</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRepairModal">
        <i class="fas fa-plus"></i> Добавить ремонт
    </button>
</div>

<!-- Статистика ремонтов -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.active_repairs }}</h4>
                        <p class="card-text">Активных</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-sync-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.completed_repairs }}</h4>
                        <p class="card-text">Завершенных</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">₽{{ "%.2f"|format(stats.total_cost) }}</h4>
                        <p class="card-text">Общая стоимость</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-ruble-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.warranty_repairs }}</h4>
                        <p class="card-text">Гарантийных</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-shield-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Активные ремонты -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="card-title mb-0">
            <i class="fas fa-sync-alt"></i> Активные ремонты
        </h5>
    </div>
    <div class="card-body">
        {% if repairs %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-warning">
                    <tr>
                        <th>ID</th>
                        <th>Товар</th>
                        <th>Производитель</th>
                        <th>Мастерская</th>
                        <th>Город</th>
                        <th>Дата начала</th>
                        <th>Дефект</th>
                        <th>Тип</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for repair in repairs %}
                    <tr>
                        <td><strong>#{{ repair.repair_id }}</strong></td>
                        <td>
                            <strong>{{ repair.product.model_name }}</strong><br>
                            <small class="text-muted">{{ repair.product.category }}</small>
                        </td>
                        <td>{{ repair.product.manufacturer.name }}</td>
                        <td>{{ repair.shop.address }}</td>
                        <td>{{ repair.shop.city.name }}</td>
                        <td>{{ repair.start_date }}</td>
                        <td>
                            <small title="{{ repair.defect_description }}">
                                {{ repair.defect_description[:50] }}{% if repair.defect_description|length > 50 %}...{% endif %}
                            </small>
                        </td>
                        <td>
                            {% if repair.client_cost == 0 %}
                                <span class="badge bg-success">Гарантия</span>
                            {% else %}
                                <span class="badge bg-info">Платный</span>
                            {% endif %}
                        </td>
                        <td>
                            <button class="btn btn-success btn-sm" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#completeRepairModal"
                                    data-repair-id="{{ repair.repair_id }}"
                                    data-product-name="{{ repair.product.model_name }}">
                                Завершить
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
            <h5>Нет активных ремонтов</h5>
            <p class="text-muted">Все ремонты завершены или еще не добавлены</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- История ремонтов -->
<div class="card">
    <div class="card-header bg-secondary text-white">
        <h5 class="card-title mb-0">
            <i class="fas fa-history"></i> История ремонтов
        </h5>
    </div>
    <div class="card-body">
        {% if all_repairs %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-secondary">
                    <tr>
                        <th>ID</th>
                        <th>Товар</th>
                        <th>Мастерская</th>
                        <th>Дата начала</th>
                        <th>Дата завершения</th>
                        <th>Стоимость</th>
                        <th>Тип</th>
                        <th>Статус</th>
                    </tr>
                </thead>
                <tbody>
                    {% for repair in all_repairs %}
                    <tr>
                        <td>#{{ repair.repair_id }}</td>
                        <td>{{ repair.product.model_name }}</td>
                        <td>{{ repair.shop.address }}</td>
                        <td>{{ repair.start_date }}</td>
                        <td>
                            {% if repair.end_date %}
                                {{ repair.end_date }}
                            {% else %}
                                <span class="badge bg-warning">В процессе</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if repair.client_cost == 0 %}
                                <span class="text-success">₽{{ "%.2f"|format(repair.actual_repair_cost) }}</span>
                            {% else %}
                                ₽{{ "%.2f"|format(repair.actual_repair_cost) }}
                            {% endif %}
                        </td>
                        <td>
                            {% if repair.client_cost == 0 %}
                                <span class="badge bg-success">Гарантия</span>
                            {% else %}
                                <span class="badge bg-info">Платный</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if repair.end_date %}
                                <span class="badge bg-secondary">Завершен</span>
                            {% else %}
                                <span class="badge bg-warning">В работе</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted text-center">Нет данных о ремонтах</p>
        {% endif %}
    </div>
</div>

<!-- Модальное окно добавления ремонта -->
<div class="modal fade" id="addRepairModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Добавить новый ремонт</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="/repairs/add">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Товар *</label>
                                <select name="product_id" class="form-select" required>
                                    <option value="">Выберите товар</option>
                                    {% for product in products %}
                                    <option value="{{ product.product_id }}">
                                        {{ product.model_name }} ({{ product.category }}) - {{ product.manufacturer.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Мастерская *</label>
                                <select name="shop_id" class="form-select" required>
                                    <option value="">Выберите мастерскую</option>
                                    {% for shop in shops %}
                                    <option value="{{ shop.shop_id }}">
                                        {{ shop.address }} ({{ shop.city.name }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Серийный номер</label>
                        <input type="text" name="serial_number" class="form-control" placeholder="Введите серийный номер">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Описание дефекта *</label>
                        <textarea name="defect_description" class="form-control" rows="3" placeholder="Подробно опишите проблему" required></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" name="is_warranty" class="form-check-input" id="warrantyCheck">
                        <label class="form-check-label" for="warrantyCheck">Гарантийный ремонт</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить ремонт</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Модальное окно завершения ремонта -->
<div class="modal fade" id="completeRepairModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle"></i> Завершить ремонт</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" id="completeRepairForm">
                <div class="modal-body">
                    <p>Вы завершаете ремонт товара: <strong id="productName"></strong></p>
                    <div class="mb-3">
                        <label class="form-label">Фактическая стоимость ремонта *</label>
                        <input type="number" name="actual_cost" class="form-control" step="0.01" min="0" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-success">Завершить ремонт</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Обработчик для модального окна завершения ремонта
document.addEventListener('DOMContentLoaded', function() {
    var completeRepairModal = document.getElementById('completeRepairModal');
    completeRepairModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var repairId = button.getAttribute('data-repair-id');
        var productName = button.getAttribute('data-product-name');
        
        document.getElementById('productName').textContent = productName;
        document.getElementById('completeRepairForm').action = '/repairs/' + repairId + '/complete';
    });
});
</script>
{% endblock %}